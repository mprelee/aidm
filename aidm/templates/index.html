<!DOCTYPE html>
<html>
<head>
    <title>AI Game Master</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #chat-container {
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }
        #input-container {
            display: flex;
            gap: 10px;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
        }
        button {
            padding: 10px 20px;
        }
        #game-controls {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #game-selector {
            flex-grow: 1;
        }
        
        #saves-dropdown {
            padding: 8px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .disabled-input {
            pointer-events: none;
            background-color: #f0f0f0;
            opacity: 0.7;
            cursor: not-allowed;
        }

        #message-input[contenteditable="false"] {
            cursor: not-allowed;
            user-select: none;
            pointer-events: none;
            color: #666;
        }

        #message-input:empty:before {
            content: attr(data-placeholder);
            color: #666;
        }

        .ai-message {
            color: #2B5BA1;  /* Accessible dark blue */
            margin: 8px 0;
        }

        .player-message {
            color: #000000;  /* Standard black */
            margin: 8px 0;
        }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.9em;
            text-align: center;
        }
        
        footer a {
            color: #2B5BA1;
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>AI Game Master</h1>
    
    <div id="game-controls">
        <button onclick="createNewGame()">âž• New Game</button>
        <div id="game-selector" style="display: none;">
            <select id="saves-dropdown">
            </select>
        </div>
        <button onclick="clearAllGames()" style="margin-left: auto;">Clear All Games</button>
    </div>

    <div id="chat-container"></div>
    <div id="ai-status" style="display: none; color: #666; font-style: italic; margin-bottom: 10px;">
        Waiting for AI response...
    </div>
    <div id="input-container">
        <div id="message-input" 
             contenteditable="true"
             style="border: 1px solid #ccc; padding: 10px; min-height: 20px; flex-grow: 1; background-color: white;"
             data-placeholder="Type your action here..."></div>
        <button id="send-button" onclick="sendMessage()">Send</button>
    </div>

    <footer>
        <p>Created by <a href="https://github.com/mprelee" target="_blank">Madeline Prelee</a></p>
        <p>
            Built with 
            <a href="https://cursor.sh/" target="_blank">Cursor</a>,
            <a href="https://platform.openai.com/" target="_blank">OpenAI</a>,
            <a href="https://railway.app/" target="_blank">Railway</a>, and
            <a href="https://python.langchain.com/docs/langgraph" target="_blank">LangGraph</a>
        </p>
        <p>
            <a href="https://github.com/mprelee/aidm" target="_blank">View on GitHub</a>
        </p>
    </footer>

    <script>
        const chatContainer = document.getElementById('chat-container');
        let currentSave = localStorage.getItem('current_game') || 'default';

        function showAIStatus() {
            document.getElementById('ai-status').style.display = 'block';
        }

        function hideAIStatus() {
            document.getElementById('ai-status').style.display = 'none';
        }

        function addToChat(message) {
            const messageElement = document.createElement('p');
            if (message.startsWith('You: ')) {
                messageElement.className = 'player-message';
            } else {
                messageElement.className = 'ai-message';
            }
            messageElement.textContent = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function saveToLocalStorage(saveName, messages) {
            const saves = JSON.parse(localStorage.getItem('game_saves') || '{}');
            saves[saveName] = {
                messages: messages,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('game_saves', JSON.stringify(saves));
            updateSaveList();
        }

        function loadFromLocalStorage(saveName) {
            const saves = JSON.parse(localStorage.getItem('game_saves') || '{}');
            return saves[saveName]?.messages || [];
        }

        function getAllSaves() {
            const saves = JSON.parse(localStorage.getItem('game_saves') || '{}');
            return Object.keys(saves)
                .filter(name => name !== 'new')
                .sort((a, b) => saves[b].timestamp.localeCompare(saves[a].timestamp));
        }

        function formatMessage(text, isPlayer) {
            return {
                text: text,
                isPlayer: isPlayer,
                timestamp: new Date().toISOString()
            };
        }

        function createNewGame() {
            const saveName = prompt('Enter a name for your game:');
            if (!saveName) return;
            
            if (saveName.toLowerCase() === 'new') {
                alert('Please choose a different name');
                return;
            }

            chatContainer.innerHTML = '';
            currentSave = saveName;
            localStorage.setItem('current_game', currentSave);
            showAIStatus();
            
            fetch('/interact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: '' })
            })
            .then(response => response.json())
            .then(data => {
                hideAIStatus();
                addToChat(data.response);
                saveToLocalStorage(currentSave, [
                    formatMessage(data.response, false)
                ]);
            })
            .catch(error => {
                hideAIStatus();
                console.error('Error:', error);
                addToChat('System: Error starting new game. Please try again.');
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.textContent.trim();
            if (!message) return;

            addToChat('You: ' + message);
            messageInput.textContent = '';
            showAIStatus();

            const messages = Array.from(chatContainer.children).map(el => 
                formatMessage(
                    el.textContent.replace(/^(You: |)/, ''),
                    el.textContent.startsWith('You: ')
                )
            );

            fetch('/interact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                hideAIStatus();
                addToChat(data.response);
                messages.push(formatMessage(data.response, false));
                saveToLocalStorage(currentSave, messages);
            })
            .catch(error => {
                hideAIStatus();
                console.error('Error:', error);
                addToChat('System: Error communicating with the server. Please try again.');
            });
        }

        function loadGame(saveName) {
            const messages = loadFromLocalStorage(saveName);
            if (!messages || messages.length === 0) {
                alert('No save found with that name');
                return;
            }

            currentSave = saveName;
            localStorage.setItem('current_game', currentSave);
            chatContainer.innerHTML = '';
            
            // Load and display all messages with proper formatting
            messages.forEach(msg => {
                if (msg.isPlayer) {
                    addToChat('You: ' + msg.text);
                } else {
                    addToChat(msg.text);
                }
            });
            
            // Scroll to bottom of chat
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateSaveList() {
            const saveList = document.getElementById('saves-dropdown');
            const gameSelector = document.getElementById('game-selector');
            const saves = getAllSaves();
            
            saveList.innerHTML = '';
            saves.forEach(saveName => {
                const option = document.createElement('option');
                option.value = saveName;
                option.textContent = saveName;
                if (saveName === currentSave) {
                    option.selected = true;
                }
                saveList.appendChild(option);
            });

            // Show/hide game selector based on whether there are any saves
            gameSelector.style.display = saves.length > 0 ? 'block' : 'none';
        }

        function clearAllGames() {
            const confirmation = prompt('Type "yes" to confirm deleting all saved games. This cannot be undone.');
            if (confirmation && confirmation.toLowerCase() === 'yes') {
                localStorage.removeItem('game_saves');
                localStorage.removeItem('current_game');
                currentSave = 'default';
                chatContainer.innerHTML = '';
                updateSaveList();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateSaveList();
            // Load the last active game or start a new default game
            const messages = loadFromLocalStorage(currentSave);
            if (messages && messages.length > 0) {
                loadGame(currentSave);
            } else {
                // Create initial game response
                fetch('/interact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: '' })
                })
                .then(response => response.json())
                .then(data => {
                    addToChat(data.response);
                    saveToLocalStorage(currentSave, [
                        formatMessage(data.response, false)
                    ]);
                });
            }
        });

        // Event Listeners
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('saves-dropdown').addEventListener('change', function(e) {
            const saveName = e.target.value;
            if (saveName) {
                loadGame(saveName);
            }
        });
    </script>
</body>
</html> 